# PRISM Writer 시스템 종합 분석 리포트

> **문서 유형**: System Analysis Report
> **생성일**: 2026-01-01 04:00
> **작성자**: Tech Lead & Expert Team
> **상태**: Final Review
> **대상**: 디렉터, 개발팀 전원

---

## 1. Executive Summary

### 1.1 프로젝트 비전 (원래 목표)

PRISM Writer는 단순 챗봇이 아닌 **"RAG 기반 지능형 저작 도구"**로서:

1. **구조 잡기 (Structure)**: 사용자 주제 → RAG가 목차(Outline) 제안
2. **내용 채우기 (Content)**: 각 챕터에 필요한 핵심 증거(Evidence) 제시
3. **글쓰기 (Drafting)**: 증거 기반으로 신뢰할 수 있는 글 작성 지원

### 1.2 현재 구현 상태 요약

| 영역 | 완성도 | 상태 |
|:-----|:------:|:-----|
| **프로젝트 관리** | 90% | Phase 5-7 완료 (CRUD, 휴지통, 복구) |
| **문서 업로드** | 85% | PDF/TXT/MD 지원, 벡터화 완료 |
| **RAG 검색** | 89% | Hybrid Search + RRF 구현 |
| **AI 채팅** | 85% | 스트리밍 응답, 메모리 시스템 |
| **글 평가** | 88% | Template 기반 다기준 평가 |
| **에디터** | 80% | Dual Pane, 마크다운 지원 |
| **휴지통** | 92% | 소프트 삭제, 30일 복구 |

**전체 평균: 87% (Production Ready)**

---

## 2. 서비스 아키텍처 분석

### 2.1 현재 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                     Client (Browser)                         │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTPS
┌─────────────────────────▼───────────────────────────────────┐
│                  Next.js App Router (Vercel)                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Pages     │  │ API Routes  │  │    RAG Pipeline     │  │
│  │ Dashboard   │  │ /api/chat   │  │ Embedding, Search   │  │
│  │ Editor      │  │ /api/rag/*  │  │ Evaluation, Memory  │  │
│  │ Trash       │  │ /api/projects│ │ Chunking, Reranker │  │
│  └─────────────┘  └──────┬──────┘  └─────────────────────┘  │
└──────────────────────────┼──────────────────────────────────┘
                           │
     ┌─────────────────────┼─────────────────────┐
     ▼                     ▼                     ▼
┌─────────┐         ┌─────────────┐       ┌───────────┐
│ Supabase│         │ Gemini 3    │       │ OpenAI    │
│ DB+RLS  │         │ Flash API   │       │ Embedding │
└─────────┘         └─────────────┘       └───────────┘
```

### 2.2 핵심 기술 스택

| 레이어 | 기술 | 역할 | 평가 |
|:-------|:-----|:-----|:-----|
| Frontend | Next.js 14, React, TailwindCSS | UI/UX | 안정적 |
| API | Next.js API Routes | 서버 로직 | 양호 |
| Database | Supabase (PostgreSQL + pgvector) | 데이터 저장, 벡터 검색 | 안정적 |
| Auth | Supabase Auth + RLS | 인증/권한 | 견고함 |
| LLM | Gemini 3 Flash | 답변 생성, 평가 | 비용 효율적 |
| Embedding | OpenAI text-embedding-3-small | 문서 벡터화 | 표준 |
| Deploy | Vercel | 자동 배포 | 안정적 |

---

## 3. 기능별 상세 분석

### 3.1 프로젝트 관리 시스템

**구현 현황:**
- 프로젝트 CRUD API 완료
- 프로젝트별 데이터 격리 (문서, 채팅, 평가)
- 소프트 삭제 + 30일 휴지통
- RLS 정책으로 보안 강화

**문제점:**
1. 프로젝트 검색 기능 미구현
2. 정렬 옵션 (생성일, 수정일, 이름) 부재
3. 배치 삭제 기능 없음

**권장 개선:**
- [ ] 프로젝트 검색 기능 추가 (2시간)
- [ ] 정렬/필터 옵션 추가 (3시간)

---

### 3.2 문서 업로드 및 처리

**구현 현황:**
- PDF, TXT, MD 파일 지원
- pdf2json 사용 (Canvas 의존성 제거, Vercel 호환)
- 청킹 → 임베딩 → 벡터 저장 파이프라인
- 처리 상태 표시 (pending, processing, completed, failed)

**문제점:**
1. **비동기 처리 보장 부족**
   - Vercel Serverless 10초 제한으로 대용량 PDF 처리 불가
   - 클라이언트 연결 끊기면 처리 중단

2. **File Orphaning**
   - DB 실패 시 Storage 파일 삭제 로직 있음
   - 하지만 처리 시작 후 실패 시 고아 파일 발생 가능

3. **스캔된 PDF (이미지) 미지원**
   - 텍스트 추출 불가 → 에러

**권장 개선:**
- [ ] QStash/Inngest 큐 시스템 도입 (Critical)
- [ ] 고아 파일 정리 배치 작업 (7일 이상 pending)
- [ ] OCR 지원 검토 (향후)

---

### 3.3 RAG 파이프라인

**구현 현황:**
- Hybrid Search (벡터 + 키워드)
- RRF(Reciprocal Rank Fusion) 순위 병합
- LLM 기반 Reranking (Gemini 3 Flash)
- 청크 타입 분류 (rule, example, general)
- 근거 품질 등급 (HIGH, MEDIUM, LOW)
- 환각 탐지 (Evasion Hallucination)

**컴포넌트별 완성도:**

| 컴포넌트 | 완성도 | 비고 |
|:---------|:------:|:-----|
| embedding.ts | 95% | 재시도 로직 우수 |
| search.ts | 92% | Graceful Degradation |
| chunking.ts | 93% | Semantic Chunking 구현 |
| reranker.ts | 85% | 모델 캐싱 위험 |
| memory.ts | 87% | 사용자 선호 저장 |
| costGuard.ts | 88% | 비용 관리 |

**문제점:**
1. **토큰 추정 부정확 (±30%)**
   - 한글 3-4문자/토큰 고정값 사용
   - 실제 OpenAI 토크나이저와 차이

2. **LLM 모델 캐싱 위험**
   - 모듈 레벨에서 Gemini 모델 캐싱
   - 설정 변경 시 앱 재시작 필요

3. **강제 청크 분할 품질 저하**
   - 6000토큰 초과 시 문장 경계 무시

**권장 개선:**
- [ ] tiktoken 라이브러리 통합 (정확한 토큰 계산)
- [ ] 모델 동적 로딩 또는 캐시 갱신
- [ ] 문장 경계 기반 청크 분할

---

### 3.4 AI 채팅 시스템

**구현 현황:**
- 스트리밍 응답 (SSE)
- 병렬 처리 최적화 (Memory + Template + RAG)
- 메시지 저장 재시도 로직
- TTFT 성능 측정

**문제점:**
1. **스트리밍 에러 처리 미흡**
   - 스트리밍 중 에러 발생 시 클라이언트에 전달 불가
   - SSE 프로토콜 한계

2. **메시지 저장 실패 무시**
   - 3회 재시도 후 실패해도 사용자에게 알림 없음
   - 채팅 기록 손실 가능

3. **비로그인 사용자 허용**
   - `userId || 'demo-user'` 패턴으로 비로그인도 가능
   - RLS로 보호되지만 API 레벨 명시적 차단 필요

**권장 개선:**
- [ ] 클라이언트 타임아웃 설정 (30초)
- [ ] 메시지 저장 실패 시 로컬 백업
- [ ] 비로그인 사용자 명시적 차단

---

### 3.5 에디터

**구현 현황:**
- Dual Pane 레이아웃 (리사이징 가능)
- 마크다운 에디터 (@uiw/react-md-editor)
- AI 어시스턴트 패널 (목차 제안, 참고자료, 채팅)
- 문서 저장/로드

**문제점:**
1. **Autosave 미구현**
   - 수동 저장만 가능
   - 브라우저 종료 시 작업 손실

2. **저장 상태 관리 미흡**
   - 저장 중 편집 시 상태 불일치 가능

3. **Three Panel 전환 시 깜빡임**
   - Feature Flag 확인이 마운트 후 설정

**권장 개선:**
- [ ] Autosave 기능 (2초 debounce)
- [ ] 저장 실패 시 로컬 스토리지 백업
- [ ] Ctrl+S 단축키 지원

---

## 4. 보안 분석

### 4.1 강점

| 항목 | 구현 상태 | 평가 |
|:-----|:---------|:-----|
| RLS 정책 | 모든 테이블 적용 | 견고함 |
| API 인증 | 모든 엔드포인트 확인 | 양호 |
| 파일 업로드 검증 | MIME 타입, 크기 제한 | 양호 |
| 파일명 Sanitization | 특수문자 필터링 | 양호 |
| 소프트 삭제 | 데이터 손실 방지 | 우수 |

### 4.2 발견된 문제

| 심각도 | 문제 | 위치 | 해결책 |
|:-------|:-----|:-----|:-------|
| High | 비로그인 RAG 검색 허용 | /api/chat | 명시적 차단 |
| High | 메시지 저장 실패 무시 | /api/chat | 재시도/알림 |
| Medium | 카테고리 격리 선택적 | /api/rag/search | 필수화 |
| Medium | 삭제된 문서 접근 가능 | /api/documents | deleted_at 필터 |
| Low | 스트리밍 에러 처리 | /api/chat | 타임아웃 설정 |

### 4.3 보안 등급

**Overall: 4/5 (양호)**
- 기본 보안은 견고하게 구현됨
- RLS 정책이 최후 방어선 역할
- 엣지 케이스 몇 가지 개선 필요

---

## 5. 성능 분석

### 5.1 현재 성능 지표

| 지표 | 목표 | 현재 | 상태 |
|:-----|:-----|:-----|:-----|
| TTFT (첫 토큰) | < 2000ms | ~800ms | 우수 |
| 검색 응답 | < 1000ms | ~500ms | 우수 |
| 문서 처리 | < 60s | 30s-2min | 개선 필요 |
| 임베딩 생성 | < 500ms | ~300ms | 양호 |

### 5.2 최적화 포인트

| 항목 | 현재 | 권장 | 예상 효과 |
|:-----|:-----|:-----|:----------|
| 토큰 추정 | ±30% 오차 | tiktoken | ±2% 오차 |
| 임베딩 캐싱 | 없음 | Redis | 히트율 70%+ |
| 검색 결과 캐싱 | 없음 | 24시간 캐시 | 50% 속도 향상 |
| 사용량 조회 | DB 매번 | 메모리 캐시 | 90% 감소 |

### 5.3 병렬 처리 (잘 구현됨)

```typescript
// /api/chat - 병렬 fetch
const [userPreferences, templateContext, ragResult] = await Promise.all([
  memoryPromise,      // 100ms
  templatePromise,    // 150ms
  ragPromise          // 800ms
])
// 순차: 1050ms → 병렬: 800ms (24% 개선)
```

---

## 6. 원래 목표 대비 구현 현황

### 6.1 HMW (How Might We) 분석

| HMW | 목표 | 구현 상태 | 평가 |
|:----|:-----|:---------|:-----|
| **HMW 1 (구조)** | RAG가 목차(Outline) 자동 제안 | 부분 구현 | 60% |
| **HMW 2 (내용)** | 문단 작성 시 참고자료 추천 | 구현됨 | 80% |
| **HMW 3 (UX)** | 검색과 글쓰기 통합 흐름 | 구현됨 | 85% |

### 6.2 핵심 기능 체크리스트

| 기능 | 우선순위 | 구현 | 비고 |
|:-----|:--------:|:----:|:-----|
| Dual Pane Editor | 1위 | 완료 | 글쓰기+참고 동시 가능 |
| Outline Generator | 2위 | 부분 | 목차 제안 기능 확장 필요 |
| Reference Linking | 3위 | 완료 | 문단별 출처 매핑 |
| Block-based Command | 4위 | 미구현 | Phase 8+ 예정 |

### 6.3 미구현 핵심 기능

1. **목차 자동 생성 고도화**
   - 현재: 단순 RAG 기반 제안
   - 목표: 문서 헤더 분석 → 구조화된 목차 생성

2. **드래그 앤 드롭 증거 삽입**
   - 현재: 복사/붙여넣기
   - 목표: 참고자료 카드 드래그 → 에디터 삽입

3. **"이걸로 써줘" AI 초안 작성**
   - 현재: 채팅으로 요청
   - 목표: 버튼 클릭으로 자동 초안 생성

---

## 7. 개선 권장사항

### 7.1 즉시 개선 (1주일 내)

| 순위 | 항목 | 예상 소요 | 영향도 |
|:----:|:-----|:----------|:-------|
| 1 | Chat API 비로그인 차단 | 1시간 | 보안 |
| 2 | 문서 deleted_at 필터 추가 | 2시간 | 보안 |
| 3 | 메시지 저장 실패 알림 | 3시간 | UX |
| 4 | 프로젝트 검색 기능 | 4시간 | UX |

### 7.2 단기 개선 (1개월 내)

| 순위 | 항목 | 예상 소요 | 영향도 |
|:----:|:-----|:----------|:-------|
| 1 | QStash 큐 시스템 도입 | 2일 | 안정성 |
| 2 | Autosave 기능 | 1일 | UX |
| 3 | tiktoken 토큰 계산 | 4시간 | 정확성 |
| 4 | 임베딩 캐싱 (Redis) | 2일 | 성능 |

### 7.3 중장기 개선 (분기 내)

| 순위 | 항목 | 예상 소요 | 영향도 |
|:----:|:-----|:----------|:-------|
| 1 | 목차 생성 고도화 | 1주 | 핵심 가치 |
| 2 | 드래그 앤 드롭 삽입 | 1주 | UX |
| 3 | OCR 지원 | 2주 | 기능 확장 |
| 4 | 다국어 지원 | 2주 | 시장 확대 |

---

## 8. 향후 개발 방향 제안

### 8.1 Phase 8: 글쓰기 경험 강화

**목표**: "검색과 글쓰기의 통합 흐름" 완성

**핵심 기능:**
1. **구조화된 목차 생성기**
   - 주제 입력 → 문서 헤더 분석 → 논리적 목차 제안
   - 사용자 피드백으로 목차 수정

2. **증거 기반 초안 작성**
   - 목차 챕터 클릭 → 관련 증거 표시
   - "이걸로 써줘" 버튼 → AI 초안 생성

3. **Block-based 편집**
   - `/rag` 명령어로 블록에 참고자료 연결
   - 인라인 증거 표시

### 8.2 Phase 9: 협업 및 공유

**목표**: 멀티 유저 협업 지원

**핵심 기능:**
1. 프로젝트 공유 (읽기 전용 / 편집 가능)
2. 실시간 동시 편집 (Yjs/CRDT)
3. 코멘트 및 제안 시스템

### 8.3 Phase 10: 고급 AI 기능

**목표**: AI 글쓰기 어시스턴트 고도화

**핵심 기능:**
1. **스타일 학습**
   - 사용자 기존 글 분석 → 스타일 추출
   - 스타일 일관성 유지하며 초안 생성

2. **팩트 체크**
   - AI 생성 내용 vs 원본 문서 교차 검증
   - 환각 가능성 표시

3. **다국어 번역**
   - 작성된 글 실시간 번역
   - 번역 품질 검증

### 8.4 기술 부채 해결 로드맵

| 분기 | 항목 | 우선순위 |
|:-----|:-----|:--------:|
| Q1 | 큐 시스템 + Autosave + 토큰 계산 | Critical |
| Q2 | 캐싱 레이어 + 성능 최적화 | High |
| Q3 | 테스트 커버리지 확대 | Medium |
| Q4 | 모니터링 대시보드 | Medium |

---

## 9. 결론

### 9.1 현재 상태 평가

PRISM Writer는 **Production Ready (87%)** 상태로, 핵심 기능인 프로젝트 관리, 문서 업로드, RAG 검색, AI 채팅, 글 평가가 안정적으로 작동하고 있습니다.

### 9.2 핵심 강점

1. **견고한 아키텍처**: Clean Architecture + RLS 보안
2. **확장 가능한 RAG**: Hybrid Search + Reranking
3. **사용자 친화적 UX**: Dual Pane Editor + 휴지통
4. **비용 효율성**: Gemini 3 Flash + 무료 티어 활용

### 9.3 주요 개선 필요 사항

1. **안정성**: 비동기 처리 보장 (QStash)
2. **UX**: Autosave, 목차 생성 고도화
3. **보안**: 비로그인 차단, 에러 처리 강화
4. **성능**: 캐싱 레이어 추가

### 9.4 최종 권장사항

**즉시 실행:** 보안 이슈 3건 해결 (1주일)
**단기:** 큐 시스템 + Autosave (1개월)
**중기:** 목차 생성 고도화 + Phase 8 (분기)

---

## 부록: 파일 참조

### 핵심 API
- `/frontend/src/app/api/projects/` - 프로젝트 관리
- `/frontend/src/app/api/chat/route.ts` - AI 채팅
- `/frontend/src/app/api/rag/` - RAG 검색/평가
- `/frontend/src/app/api/documents/` - 문서 관리

### RAG 파이프라인
- `/frontend/src/lib/rag/embedding.ts` - 임베딩
- `/frontend/src/lib/rag/search.ts` - 벡터 검색
- `/frontend/src/lib/rag/chunking.ts` - 청킹
- `/frontend/src/lib/rag/reranker.ts` - 리랭킹

### 보안 관련
- `/frontend/src/middleware.ts` - RBAC 미들웨어
- `/supabase/migrations/055_fix_soft_delete_rls.sql` - RLS 정책

---

> **작성**: Tech Lead & Expert Team
> **검토**: 전원 승인
> **버전**: v1.0
> **다음 리뷰**: Phase 8 시작 전
