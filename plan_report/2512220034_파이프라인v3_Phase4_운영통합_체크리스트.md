# Phase 4: ë³´ì•ˆ, ìš´ì˜, ê¸°ìˆ  ë¶€ì±„ í†µí•© ì²´í¬ë¦¬ìŠ¤íŠ¸

> **ìƒì„±ì¼**: 2025-12-22  
> **ë‹´ë‹¹**: ì‹œë‹ˆì–´ ê°œë°œì, ë³´ì•ˆ ì—”ì§€ë‹ˆì–´  
> **ì˜ˆìƒ ê¸°ê°„**: 1ì£¼  
> **ì„ í–‰ ì¡°ê±´**: Phase 1 ì™„ë£Œ (`tenant_id` ì»¬ëŸ¼ ì¡´ì¬), Phase 2 ì™„ë£Œ (`TemplateRegistry` ì¡´ì¬)

---

## âš ï¸ ì˜í–¥ë°›ì„ ìˆ˜ ìˆëŠ” ê¸°ì¡´ ê¸°ëŠ¥

| ê¸°ëŠ¥              | íŒŒì¼                              | ì˜í–¥ë„ | í™•ì¸ ë°©ë²•           |
| ----------------- | --------------------------------- | ------ | ------------------- |
| ëª¨ë“  ë°ì´í„° ì ‘ê·¼  | Supabase RLS ì •ì±…                 | ê³      | ë°ì´í„° ì¡°íšŒ í…ŒìŠ¤íŠ¸  |
| ê¸°ì¡´ Rubrics í‰ê°€ | `frontend/src/lib/rag/rubrics.ts` | ê³      | í‰ê°€ ê¸°ëŠ¥ ì •ìƒ ë™ì‘ |
| í…”ë ˆë©”íŠ¸ë¦¬ ë¡œê¹…   | `frontend/src/lib/telemetry.ts`   | ì¤‘     | ë¡œê·¸ ê¸°ë¡ í™•ì¸      |

---

## ğŸ“‹ Task 4.1: Namespace Isolation (RLS ì •ì±…)

### ğŸ¯ ëª©í‘œ

Tenantë³„ ë°ì´í„° ê²©ë¦¬ë¥¼ ìœ„í•œ RLS ì •ì±… ê°•í™”

### ğŸ“ ìˆ˜ì • íŒŒì¼

- **[NEW]** `backend/migrations/023_tenant_rls_policies.sql`

### âš¡ ì´ì „ Taskì™€ì˜ ì—°ê²°

- Phase 1ì˜ `tenant_id` ì»¬ëŸ¼ í™œìš©

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **4.1.1** `rag_documents` RLS ì •ì±…
- [x] **4.1.2** `rag_rules` RLS ì •ì±…
- [x] **4.1.3** `rag_examples` RLS ì •ì±…
- [x] **4.1.4** `rag_templates` RLS ì •ì±…
- [x] **4.1.5** ê´€ë¦¬ì ì˜ˆì™¸ ì²˜ë¦¬

### ğŸ” Phase 4.1 ê²€ì¦

- [x] ì¼ë°˜ ì‚¬ìš©ì: ë³¸ì¸ ë°ì´í„°ë§Œ ì¡°íšŒ í™•ì¸
- [x] ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ì ‘ê·¼ ì‹œ ë¹ˆ ê²°ê³¼ ë°˜í™˜ í™•ì¸
- [x] ê´€ë¦¬ì: ëª¨ë“  ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥ í™•ì¸

---

## ğŸ“‹ Task 4.2: Telemetry ì§€í‘œ ìˆ˜ì§‘

### ğŸ¯ ëª©í‘œ

Template Lifecycle ê´€ë ¨ ì§€í‘œ ìˆ˜ì§‘ ë° ë¡œê¹…

### ğŸ“ ìˆ˜ì • íŒŒì¼

- **[MODIFY]** `frontend/src/lib/telemetry.ts`
- **[NEW]** `backend/migrations/024_telemetry_template_metrics.sql`

### âš¡ ì´ì „ Taskì™€ì˜ ì—°ê²°

- Phase 2ì˜ `TemplateBuilder` ì´ë²¤íŠ¸ ì—°ë™

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **4.2.1** í…œí”Œë¦¿ ë¹Œë“œ ì´ë²¤íŠ¸ ë¡œê¹…
- [x] **4.2.2** ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ API
- [x] **4.2.3** í”¼ë“œë°± UI ì»´í¬ë„ŒíŠ¸
- [x] **4.2.4** ì§€í‘œ ì§‘ê³„ í…Œì´ë¸”
- [x] **4.2.5** A/B í…ŒìŠ¤íŠ¸ ì¸í”„ë¼

### ğŸ” Phase 4.2 ê²€ì¦

- [x] ë¹Œë“œ ì´ë²¤íŠ¸ ë¡œê·¸ Supabaseì— ê¸°ë¡ í™•ì¸
- [x] í”¼ë“œë°± API í˜¸ì¶œ â†’ `template_feedback` í…Œì´ë¸” ì €ì¥ í™•ì¸
- [x] í”¼ë“œë°± ë²„íŠ¼ UI ë™ì‘ í™•ì¸

---

## ğŸ“‹ Task 4.3: Rubrics Migration (ê³µì¡´ Phase)

### ğŸ¯ ëª©í‘œ

ê¸°ì¡´ `rubrics.ts`ì™€ v3 í…œí”Œë¦¿ ì‹œìŠ¤í…œ ê³µì¡´

### ğŸ“ ìˆ˜ì • íŒŒì¼

- **[NEW]** `frontend/src/lib/rag/rubricAdapter.ts`
- **[MODIFY]** `frontend/src/lib/rag/rubrics.ts` (Deprecated ì£¼ì„)
- **[NEW]** `frontend/src/lib/rag/shadowModeLogger.ts`
- **[MODIFY]** `frontend/src/app/api/rag/evaluate/route.ts`

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **4.3.1** `RubricAdapter` í´ë˜ìŠ¤ êµ¬í˜„
- [x] **4.3.2** ê¸°ì¡´ `rubrics.ts` Deprecated ì£¼ì„
- [x] **4.3.3** Feature Flag ê¸°ë°˜ ë¶„ê¸° (`NEXT_PUBLIC_USE_V3_TEMPLATES`)
- [x] **4.3.4** Shadow Mode êµ¬í˜„ ë° ë¡œê¹… ì—°ë™

### ğŸ” Phase 4.3 ê²€ì¦

- [x] Feature Flag OFF: ê¸°ì¡´ v2 ë™ì‘ í™•ì¸ (ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼)
- [x] Feature Flag ON: v3 ë™ì‘ ë° Shadow Mode ë¡œê¹… í™•ì¸ (ì½”ë“œ ë ˆë²¨ í™•ì¸)
- [x] `npm run build` ì„±ê³µ í™•ì¸

---

## ğŸ“‹ Task 4.4: ê´€ë¦¬ì í…œí”Œë¦¿ ìŠ¹ì¸ UI

### ğŸ¯ ëª©í‘œ

HITL(Human-in-the-Loop) í…œí”Œë¦¿ ìŠ¹ì¸ UI

### ğŸ“ ìˆ˜ì • íŒŒì¼

- **[NEW]** `frontend/src/app/admin/templates/page.tsx`
- **[NEW]** `frontend/src/components/admin/TemplateReviewCard.tsx`
- **[NEW]** `frontend/src/app/api/admin/templates/[id]/approve/route.ts`
- **[NEW]** `frontend/src/app/api/admin/templates/[id]/reject/route.ts`
- **[MODIFY]** `frontend/src/lib/rag/templateRegistry.ts`

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **4.4.1** í…œí”Œë¦¿ ëª©ë¡ í˜ì´ì§€ êµ¬í˜„
- [x] **4.4.2** `TemplateReviewCard` ì»´í¬ë„ŒíŠ¸ ê°œë°œ
- [x] **4.4.3** ìŠ¹ì¸ API êµ¬í˜„
- [x] **4.4.4** ë°˜ë ¤ API êµ¬í˜„

### ğŸ” Phase 4.4 ê²€ì¦

- [x] ê´€ë¦¬ì ë¡œê·¸ì¸ â†’ `/admin/templates` ì ‘ê·¼ ê°€ëŠ¥ í™•ì¸
- [x] ì¼ë°˜ ì‚¬ìš©ì â†’ ì ‘ê·¼ ë¶ˆê°€ í™•ì¸ (ì½”ë“œ ë ˆë²¨ ê¶Œí•œ ì²´í¬)
- [x] ìŠ¹ì¸ ë²„íŠ¼ â†’ ìƒíƒœ ë³€ê²½ í™•ì¸
- [x] ë°˜ë ¤ ë²„íŠ¼ â†’ ì‚¬ìœ  ì…ë ¥ í›„ ìƒíƒœ ë³€ê²½ í™•ì¸
- [x] `npm run build` ì„±ê³µ í™•ì¸

---

## âœ… Phase 4 ìµœì¢… ê²€ì¦

### ìë™í™” ê²€ì¦

- [ ] `npm run build` (frontend) ì„±ê³µ
- [ ] `npx vitest run` ì „ì²´ í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] `npx tsc --noEmit` íƒ€ì… ì˜¤ë¥˜ ì—†ìŒ

### ë³´ì•ˆ ê²€ì¦

- [ ] RLS ì •ì±…: ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€
- [ ] ê´€ë¦¬ì API: ì¼ë°˜ ì‚¬ìš©ì í˜¸ì¶œ ì‹œ 401/403 ë°˜í™˜
- [ ] ê°œì¸ì •ë³´: í…”ë ˆë©”íŠ¸ë¦¬ì— ë¯¼ê° ì •ë³´ ë¯¸í¬í•¨

### ê¸°ëŠ¥ ê²€ì¦

- [ ] Feature Flag ì „í™˜ ì •ìƒ ë™ì‘
- [ ] Shadow Mode ë¡œê¹… ì •ìƒ
- [ ] ê´€ë¦¬ì ìŠ¹ì¸ UI ì •ìƒ ë™ì‘

### ê¸°ì¡´ ê¸°ëŠ¥ ì •ìƒ ë™ì‘ í™•ì¸

- [ ] ëª¨ë“  ê¸°ì¡´ í˜ì´ì§€ ì ‘ê·¼ ì •ìƒ
- [ ] ê¸°ì¡´ v2 í‰ê°€ ê¸°ëŠ¥ ì •ìƒ
- [ ] ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì •ìƒ

### í’ˆì§ˆ ì²´í¬

- [ ] ì½”ë”© ìŠ¤íƒ€ì¼: ESLint ì˜¤ë¥˜ ì—†ìŒ
- [ ] í•¨ìˆ˜ëª…/ë³€ìˆ˜ëª…: ëª…í™•í•˜ê³  ì¼ê´€ì„± ìˆìŒ
- [ ] ì—ëŸ¬ ì²˜ë¦¬: ê¶Œí•œ ì˜¤ë¥˜, ë°ì´í„° ì˜¤ë¥˜ ì ì ˆíˆ ì²˜ë¦¬
- [ ] ì„±ëŠ¥: RLS ì¡°ì¸ ì¿¼ë¦¬ ì„±ëŠ¥ í™•ì¸
- [ ] ì ‘ê·¼ì„±: ê´€ë¦¬ì UI í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜, aria-label

---

## ğŸ‰ ì „ì²´ Pipeline v3 ì™„ë£Œ

ëª¨ë“  Phaseê°€ ì™„ë£Œë˜ë©´ ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

1. **ìµœì¢… í†µí•© í…ŒìŠ¤íŠ¸**: ë¬¸ì„œ ì—…ë¡œë“œ â†’ í…œí”Œë¦¿ ë¹Œë“œ â†’ ìŠ¹ì¸ â†’ ì‚¬ìš©ì ê¸€ í‰ê°€ â†’ 3ë‹¨ ë¹„êµ ë·° ì „ì²´ íë¦„
2. **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**: ëŒ€ìš©ëŸ‰ ë¬¸ì„œ, ë™ì‹œ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸
3. **ë°°í¬**: Feature Flagë¥¼ í†µí•´ ì ì§„ì  ë¡¤ì•„ì›ƒ
4. **ëª¨ë‹ˆí„°ë§**: Telemetry ëŒ€ì‹œë³´ë“œë¡œ ì§€í‘œ ëª¨ë‹ˆí„°ë§
5. **ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ**: 3ê°œì›” í›„ `rubrics.ts` ì œê±° (Phase 4 of Tech Debt)
