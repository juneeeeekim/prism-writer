# 🏗️ PrismLM 아키텍처 리팩토링 마스터 플랜

> **생성일**: 2025-12-29 03:07  
> **상태**: 📋 회의 완료, 실행 대기  
> **참조 문서**:
>
> - [Pipeline_Redefinition_v2.md](./2512212200_Pipeline_Redefinition_v2.md)
> - [파이프라인 재정의\_v2.md](./2512251330_파이프라인%20재정의_v2.md)
> - [RAG_pipeline_redesign_analysis.md](./2512180737_RAG_pipeline_redesign_analysis.md)

---

## 📌 Executive Summary (경영진 요약)

### 문제 진단

- **서비스 자체는 올바르게 구축됨** (글쓰기, 평가, 채팅 기능 모두 동작)
- **아키텍처가 잘못됨**: "글쓰기 후에 RAG를 붙이는" 순서로 개발되어, RAG 파이프라인이 기반이 아닌 부가 기능처럼 작동
- **결과**: RLS 정책 누락, RPC 반환 타입 불일치, 타입 정의 누락 등 지속적 에러 발생

### 해결 방향

"Template Builder → Judge" 구조를 **점진적으로 도입**하되, 기존 서비스 기능은 그대로 유지하고 **아키텍처만 리팩토링**

---

## 🧠 Chain of Thought: 우선순위 결정 논리

### Step 1: 현재 상황 정의

```
[현재]
글쓰기 기능 ──┬── RAG 검색 ──┬── 평가 기능
              │              │
              └── (부가)  ───┘
                       ↑
                   불안정한 기반
```

### Step 2: 두 가지 접근법 분석

| 접근법                      | 설명                                           | 장점                          | 단점                                    |
| --------------------------- | ---------------------------------------------- | ----------------------------- | --------------------------------------- |
| **A. 에러 먼저 수정**       | 현재 발생 중인 에러를 모두 수정한 후 리팩토링  | 즉시 안정화, 사용자 불편 해소 | 근본 원인 미해결, 에러 재발 가능성      |
| **B. RAG 기반 재정비 먼저** | 아키텍처를 먼저 올바르게 재정비한 후 기능 연결 | 근본 원인 해결, 장기 안정성   | 단기간 불안정, 리팩토링 중 새 에러 가능 |

### Step 3: 깊은 분석 (Chain of Thought)

```
질문: 에러를 먼저 수정하면 문제가 해결되는가?

↓

분석: 오늘 수정한 에러들의 패턴 확인
- 202512290140_fix_chunks_rls_and_columns.sql (RLS 정책 누락)
- 202512290220_fix_rpc_return.sql (RPC 반환 타입 불일치)
- Holistic Evaluation 결과 저장 실패 (타입 정의 누락)

↓

결론: 모두 "후순위로 추가된 기능"에서 발생한 에러
      → 에러만 수정해도 **비슷한 패턴의 에러가 재발**할 것

↓

따라서: 근본적인 아키텍처 수정이 필요
        단, 현재 에러로 인해 **테스트가 불가능**하면 리팩토링 검증 불가

↓

최종 결론: "최소한의 에러 수정" 후 "RAG 기반 재정비" 진행
           (완전 안정화가 아닌, 테스트 가능한 수준까지만)
```

### Step 4: 최종 우선순위 결정

| 순서 | Phase       | 내용                                           |
| ---- | ----------- | ---------------------------------------------- |
| 1    | **Phase 0** | 테스트 가능한 수준으로 Critical 에러만 수정    |
| 2    | **Phase 1** | RAG 기반 계층 재정비 (테이블, RLS, RPC 재설계) |
| 3    | **Phase 2** | Template Builder 구조 도입                     |
| 4    | **Phase 3** | 기존 기능 연결 (평가, 채팅)                    |
| 5    | **Phase 4** | 검증 및 마이그레이션 완료                      |

---

## 👥 전문가 회의: 우선순위 투표

### 안건: "에러 수정 먼저" vs "RAG 기반 재정비 먼저"

| 역할                 | 투표  | 근거                                                      |
| -------------------- | ----- | --------------------------------------------------------- |
| 🧑‍💼 시니어 개발자     | 🅰️+🅱️ | "에러 수정은 테스트 가능한 수준까지만. 그 후 바로 재정비" |
| 🔎 IR/검색 엔지니어  | 🅱️    | "검색 기반이 흔들리면 모든 테스트가 무의미"               |
| 🧠 LLM/RAG 아키텍트  | 🅱️    | "RPC 함수가 계속 바뀌는 건 설계 문제. 기반부터 고쳐야 함" |
| 🧩 프롬프트 엔지니어 | 🅰️    | "사용자가 지금 쓰고 있으면 에러 먼저 해결"                |
| 📏 Eval 전문가       | 🅱️    | "테스트 케이스가 자꾸 깨지는 건 구조 문제"                |
| 🧪 QA 리드           | 🅰️+🅱️ | "Critical만 수정, 나머지는 재정비 과정에서 해결"          |
| 🧱 데이터 엔지니어   | 🅱️    | "스키마가 자꾸 바뀌면 데이터 일관성 무너짐"               |
| 🔐 보안 엔지니어     | 🅱️    | "RLS 정책이 후순위로 추가되는 건 보안 리스크"             |
| ⚙️ MLOps/SRE         | 🅰️+🅱️ | "배포 안정성 위해 최소 수정 후 점진적 전환"               |
| 🧑‍🎨 UX/프론트         | 🅰️    | "사용자 경험 먼저"                                        |

### 투표 결과

| 선택지                                      | 득표 | 비율 |
| ------------------------------------------- | ---- | ---- |
| 🅰️ 에러 먼저 수정                           | 2    | 20%  |
| 🅱️ RAG 기반 재정비 먼저                     | 5    | 50%  |
| 🅰️+🅱️ 하이브리드 (최소 에러 수정 후 재정비) | 3    | 30%  |

### ✅ 채택된 전략: **하이브리드 접근**

> **Phase 0**: 테스트가 가능한 수준까지 **Critical 에러만** 수정 (1~2시간)  
> **Phase 1 이후**: RAG 기반 계층 재정비 및 Template Builder 도입

---

## 📋 상세 체크리스트

### 🔴 Phase 0: Critical 에러 수정 (테스트 가능 상태 확보)

**목표**: 리팩토링 검증이 가능한 상태로 만들기

**예상 소요**: 1~2시간

| ID    | 작업                                                         | 상태 | 담당     |
| ----- | ------------------------------------------------------------ | ---- | -------- |
| P0-01 | RPC 함수 `match_document_chunks` 반환 타입 확인 및 배포      | ⬜   | DB       |
| P0-02 | `rag_chunks` RLS 정책 적용 확인                              | ⬜   | DB       |
| P0-03 | `HolisticFeedbackPanel` null safety 수정                     | ⬜   | Frontend |
| P0-04 | 타입 정의 `V5EvaluationResult`에 `holistic_result` 필드 추가 | ⬜   | Frontend |
| P0-05 | 개발 서버 실행 및 기본 동작 확인                             | ⬜   | QA       |

**완료 기준**:

- [ ] `npm run dev` 에러 없이 실행
- [ ] 문서 업로드 → 처리 → 검색 기본 흐름 동작
- [ ] 평가 결과 저장/로드 정상 동작

---

### 🟠 Phase 1: RAG 기반 계층 재정비

**목표**: RAG 시스템을 "부가 기능"에서 "기반 계층"으로 재배치

**예상 소요**: 4~6시간

#### Phase 1.1: 데이터 모델 정리

| ID    | 작업                                       | 상태 | 설명                             |
| ----- | ------------------------------------------ | ---- | -------------------------------- |
| P1-01 | `rag_chunks` 테이블 스키마 최종 확정       | ⬜   | 필수 컬럼 정리, 불필요 컬럼 제거 |
| P1-02 | `user_documents` 테이블 스키마 최종 확정   | ⬜   | `started_at`, `updated_at` 등    |
| P1-03 | RPC 함수 `match_document_chunks` 계약 고정 | ⬜   | 반환 타입 변경 금지              |
| P1-04 | TypeScript 타입 정의와 DB 스키마 동기화    | ⬜   | `types/rag.ts`                   |

#### Phase 1.2: RLS 정책 체계화

| ID    | 작업                                   | 상태 | 설명                                      |
| ----- | -------------------------------------- | ---- | ----------------------------------------- |
| P1-05 | `user_documents` RLS 정책 검토 및 확정 | ⬜   |                                           |
| P1-06 | `rag_chunks` RLS 정책 검토 및 확정     | ⬜   | JOIN 기반 → 직접 `user_id` 컬럼 추가 검토 |
| P1-07 | RLS 정책 테스트 케이스 작성            | ⬜   |                                           |

#### Phase 1.3: API 계층 정리

| ID    | 작업                                         | 상태 | 설명               |
| ----- | -------------------------------------------- | ---- | ------------------ |
| P1-08 | `/api/documents/process` 흐름 검토 및 문서화 | ⬜   |                    |
| P1-09 | `/api/rag/*` 엔드포인트 계약 정의            | ⬜   | 입출력 스키마 고정 |
| P1-10 | 에러 핸들링 패턴 통일                        | ⬜   |                    |

**검증 기준**:

- [ ] 문서 업로드 → 청킹 → 임베딩 → 저장 전체 흐름 동작
- [ ] RAG 검색 API가 일관된 응답 반환
- [ ] RLS 정책이 의도대로 동작 (타 사용자 문서 접근 불가)

---

### 🟡 Phase 2: Template Builder 구조 도입

**목표**: 평가 기준을 프롬프트 하드코딩에서 데이터 기반으로 전환

**예상 소요**: 6~8시간

#### Phase 2.1: 스키마 설계

| ID    | 작업                          | 상태 | 설명                        |
| ----- | ----------------------------- | ---- | --------------------------- |
| P2-01 | `rag_rules` 테이블 설계       | ⬜   | 문서에서 추출된 원자적 규칙 |
| P2-02 | `rag_examples` 테이블 설계    | ⬜   | 좋은 예시/나쁜 예시         |
| P2-03 | `rag_templates` 테이블 설계   | ⬜   | 규칙 + 예시 결합            |
| P2-04 | 테이블 간 관계 정의 (Lineage) | ⬜   | `source_chunk_ids`          |

#### Phase 2.2: Template JSON 스키마 정의

| ID    | 작업                      | 상태 | 설명           |
| ----- | ------------------------- | ---- | -------------- |
| P2-05 | Template JSON 스키마 확정 | ⬜   | 아래 구조 참조 |

```json
{
  "criteria_id": "string",
  "rationale": "왜 이 규칙이 중요한가",
  "positive_examples": ["좋은 사례 1", "2"],
  "negative_examples": ["나쁜 사례 1", "2"],
  "remediation_steps": ["어떻게 고쳐야 하는가"],
  "source_citations": ["원문 인용구 1"]
}
```

#### Phase 2.3: 마이그레이션 스크립트

| ID    | 작업                  | 상태 | 설명                    |
| ----- | --------------------- | ---- | ----------------------- |
| P2-06 | 마이그레이션 SQL 작성 | ⬜   | `040_rag_templates.sql` |
| P2-07 | 로컬 테스트           | ⬜   |                         |
| P2-08 | Supabase 배포         | ⬜   |                         |

**검증 기준**:

- [ ] 새 테이블 생성 완료 (`rag_rules`, `rag_examples`, `rag_templates`)
- [ ] RLS 정책 적용 완료
- [ ] 기존 기능에 영향 없음 (회귀 테스트)

---

### 🟢 Phase 3: 기존 기능 연결

**목표**: 평가, 채팅 기능을 Template 기반으로 연결

**예상 소요**: 4~6시간

#### Phase 3.1: Adapter 패턴 구현

| ID    | 작업                                    | 상태 | 설명                         |
| ----- | --------------------------------------- | ---- | ---------------------------- |
| P3-01 | `RubricAdapter` 인터페이스 정의         | ⬜   | v2 Rubric ↔ v3 Template 변환 |
| P3-02 | 기존 `rubrics.ts` 유지하며 Adapter 연결 | ⬜   |                              |

#### Phase 3.2: 평가 기능 연결

| ID    | 작업                                    | 상태 | 설명                     |
| ----- | --------------------------------------- | ---- | ------------------------ |
| P3-03 | `evaluate-single` API에 Template 지원   | ⬜   | Feature Flag로 전환 가능 |
| P3-04 | `evaluate-holistic` API에 Template 지원 | ⬜   |                          |
| P3-05 | 평가 결과에 `source_citations` 포함     | ⬜   |                          |

#### Phase 3.3: 채팅 기능 연결

| ID    | 작업                                   | 상태 | 설명 |
| ----- | -------------------------------------- | ---- | ---- |
| P3-06 | 채팅 RAG 검색에 Template 컨텍스트 추가 | ⬜   |      |
| P3-07 | 채팅 응답에 예시 기반 설명 포함        | ⬜   |      |

**검증 기준**:

- [ ] Feature Flag로 v2/v3 전환 가능
- [ ] v3 모드에서 평가 결과에 인용 포함
- [ ] 기존 v2 모드 정상 동작 (회귀 테스트)

---

### 🔵 Phase 4: 검증 및 완료

**목표**: 전체 시스템 안정성 확인 및 문서화

**예상 소요**: 2~3시간

| ID    | 작업                 | 상태 | 설명                                    |
| ----- | -------------------- | ---- | --------------------------------------- |
| P4-01 | 전체 흐름 E2E 테스트 | ⬜   | 문서 업로드 → 처리 → 검색 → 평가 → 채팅 |
| P4-02 | 성능 테스트          | ⬜   | 응답 시간 목표 P95 < 3000ms             |
| P4-03 | 보안 테스트          | ⬜   | RLS 정책, 권한 검사                     |
| P4-04 | 문서화 업데이트      | ⬜   | README, API 문서                        |
| P4-05 | Walkthrough 작성     | ⬜   | 리팩토링 결과 요약                      |

---

## 🎯 성공 기준 (KPI)

| 지표                    | 현재        | 목표         |
| ----------------------- | ----------- | ------------ |
| RPC 함수 변경 빈도      | 주 2~3회    | 월 1회 미만  |
| 스키마 관련 에러        | 주 5건 이상 | 주 1건 미만  |
| 평가 API 평균 응답 시간 | 측정 필요   | P95 < 3000ms |
| 인용 기반 평가 비율     | 0%          | 80% 이상     |

---

## 📊 전체 진행률

```
[Phase 0] ████████░░ 에러 수정 중
[Phase 1] ░░░░░░░░░░ 대기
[Phase 2] ░░░░░░░░░░ 대기
[Phase 3] ░░░░░░░░░░ 대기
[Phase 4] ░░░░░░░░░░ 대기
```

---

## 🚦 리스크 및 대응 방안

| 리스크                        | 가능성 | 영향도 | 대응 방안                        |
| ----------------------------- | ------ | ------ | -------------------------------- |
| 리팩토링 중 새 에러 발생      | 높음   | 중간   | Feature Flag로 롤백 가능하게     |
| 기존 데이터 마이그레이션 실패 | 중간   | 높음   | 백업 후 진행, 롤백 스크립트 준비 |
| 예상보다 긴 작업 시간         | 중간   | 중간   | Phase별 우선순위 재조정          |
| 사용자 영향                   | 낮음   | 높음   | 점진적 배포, 모니터링 강화       |

---

## 📝 다음 단계

1. [ ] 사장님 승인
2. [ ] Phase 0 시작 (에러 수정)
3. [ ] 로컬 개발 서버 실행 및 실시간 테스트 환경 구축
4. [ ] Phase별 진행

---

## 📚 부록: 참조 문서

- [Pipeline_v3_Master_Checklist.md](./2512220034_Pipeline_v3_Master_Checklist.md)
- [Pipeline_Redefinition_v2.md](./2512212200_Pipeline_Redefinition_v2.md)
- [파이프라인 재정의\_v2.md](./2512251330_파이프라인%20재정의_v2.md)
- [RAG_pipeline_redesign_analysis.md](./2512180737_RAG_pipeline_redesign_analysis.md)

---

> **문서 작성**: Tech Lead (AI)  
> **승인 대기**: 사장님
