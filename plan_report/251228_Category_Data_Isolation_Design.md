# 🚀 카테고리 격리 고도화 및 RAG 통합 설계서 (v2.0)

**문서 ID**: 2512281630_Category_Data_Isolation_Design_v2
**작성일**: 2025-12-28
**작성자**: Tech Lead (AI Assistant)
**상태**: **[Phase 1-3 기초 구현 완료]** → **[고도화 단계 착수]**

---

## 1. 개요 (Executive Summary)

본 문서는 Phase 1~3에서 완료된 DB 스키마 및 기초 태깅 기능을 넘어, 사용자가 **카테고리별 지식을 실제 업무에 효율적으로 활용**할 수 있도록 하는 고도화 설계에 집중합니다.

**핵심 과제:**

1. **지식 소스 자동화**: 직접 복사/붙여넣기 대신, 선택한 카테고리의 기존 문서(Chunks)를 즉시 활용.
2. **채팅 격리 강화**: 채팅 시 현재 문서의 카테고리 외 다른 지식이 섞이지 않도록 RAG 엔진 강제 격리.
3. **사용자 경험(UX) 고도화**: 지식 소스에 따른 동적 UI 분기 처리.

---

## 2. 고도화 집중 분석 (Gap Analysis)

| 기능 영역              | 보완 필요 내용                                   | 기대 효과                        |
| :--------------------- | :----------------------------------------------- | :------------------------------- |
| **UI/UX (Panel)**      | 소스 선택(자동/수동) 토글 및 조건부 렌더링       | 사용 편의성 증대, 입력 실수 방지 |
| **Backend (Retrieve)** | 카테고리별 대량 청크(Chunks) 추출 로직           | 지식 생성 속도 10배 향상         |
| **Search API (RAG)**   | 런타임 카테고리 필터(`category_param`) 강제 적용 | 완벽한 보안 및 지식 격리 달성    |

---

## 3. 상세 고도화 설계 (Deep Dive)

### 3.1 [UI/UX] 스마트 지식 소스 선택기 (Phase 2 Upgrade)

사용자가 일일이 텍스트를 입력하지 않아도 되도록 UI를 개편합니다.

- **컴포넌트**: `SyntheticDataPanel.tsx`
- **UI 로직**:
  - `sourceType` 상태 추가 (`'manual' | 'existing'`)
  - **'existing' 선택 시**: 텍스트 입력창(`textarea`)을 숨기고, "해당 카테고리의 모든 지식을 활용합니다"라는 안내 메시지와 함께 '청크 요약 정보' 표시.
  - **'manual' 선택 시**: 기존 텍스트 입력창 노출.

### 3.2 [API] 자동 지식 추출 엔진 (Phase 3 Upgrade)

`useExistingChunks` 파라미터를 처리하는 지능형 로직을 백엔드에 구축합니다.

- **엔드포인트**: `POST /api/raft/generate`
- **작동 시나리오**:
  1. 요청 바디에서 `useExistingChunks: true` 확인.
  2. `document_chunks` 테이블에서 `category = requested_category`인 모든 데이터 조회.
  3. `content`들을 합쳐 하나의 거대한 `context` 문자열 생성 (토큰 한도 내 최적화 필요).
  4. 생성된 `context`를 기반으로 LLM Q&A 생성 시작.

### 3.3 [RAG] 런타임 지식 격리 (Phase 4 Logic)

채팅 엔진이 카테고리 필터를 '반드시' 사용하도록 강제합니다.

- **엔드포인트**: `POST /api/rag/search`
- **수정 사항**:
  - 요청 시 `documentId` 또는 `category`를 필수 인자로 수신.
  - Supabase RPC 호출 시 `category_param` 위치에 해당 카테고리 주입.
  - **격리 원칙**: 카테고리 값이 없거나 잘못된 경우 검색을 거부하거나 빈 결과를 반환하여 보안 유지.

---

## 4. 고도화 구현 체크리스트 (Updated)

### 🛠️ Phase A: UI 소스 토글 구현 (UX 전문가 주도)

- [ ] **A-01**: `sourceType` 상태 변수 및 라디오 버튼 UI 추가
- [ ] **A-02**: 선택값에 따른 `textarea` 조건부 렌더링 (애니메이션 적용)
- [ ] **A-03**: 선택된 카테고리의 청크 개수 미리보기 표시 (사용자 피드백)

### ⚙️ Phase B: 백엔드 지식 추출 로직 (주니어 개발자 주도)

- [ ] **B-01**: `api/raft/generate` 내 `useExistingChunks` 분기 로직 작성
- [ ] **B-02**: Supabase에서 카테고리별 청크 대량 인출(`fetch`) 최적화
- [ ] **B-03**: 추출된 텍스트의 토큰 한도 체크 및 컨텍스트 결합 알고리즘 적용

### 🔒 Phase C: RAG 카테고리 격리 강제 (기술 리더 주도)

- [ ] **C-01**: `api/rag/search` 요청 프로토콜에 `category` 필드 추가
- [ ] **C-02**: `match_document_chunks` RPC 호출 시 필터 매개변수 연동
- [ ] **C-03**: 교데이터 검색 테스트 (A 문서에서 B 지식 검색 시 차단 확인)

---

## 5. 기대 효과 및 목표

- **효율성**: 데이터 생성 시 복사/붙여넣기 과정이 제거되어 작업 시간 80% 단축.
- **정확성**: 실제 문서(Chunks) 기반 생성으로 환각(Hallucination) 감소.
- **보안**: 카테고리 간 지식 간섭이 0% 인 완벽한 격리 RAG 시스템 완성.

---

_수정일: 2025-12-28 | 작성자: Tech Lead_
