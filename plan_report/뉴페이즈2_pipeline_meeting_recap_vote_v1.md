# 📌 파이프라인 아이디어 회의(재소집) — 역할별 제출본 통합 + 크로스체크 + 우선순위(투표) 고정안
- 버전: v1.0
- 기준: 현재 합의된 핵심 파이프라인(루브릭별 Retrieval → 하이브리드/리랭킹 → Evidence Pack → Judge(JSON/근거강제) → Citation/Consistency Gate → Telemetry(run_id) → 개선 루프)

---

## 0) 질문 카운트 알림
- 현재 질문 카운트: **22 / 30** (10단위 기준으로 **20을 초과**했습니다)

---

## 1) [팩트] 지금까지 합의된 “핵심 파이프라인”
1. **루브릭별 Retrieval**
2. **(하이브리드/리랭킹)**
3. **Evidence Pack**
4. **Judge (JSON Contract + 근거 인용 강제 / 근거 없으면 ‘근거 부족’)**
5. **Citation Gate + Consistency Gate**
6. **Telemetry(run_id)**
7. **개선 루프(회귀·Hard Negative·튜닝)**

---

## 2) 참석자(역할) & 제출 요약(각자 관점)
> 표기 규칙:  
> - **[팩트]**: 구현/운영에서 일반적으로 검증된 원칙(또는 이미 합의된 항목)  
> - **[의견]**: 이번 시스템 의사결정을 위한 제안/우선순위/트레이드오프

### 2.1 시니어 개발자(사회/통합)
- **[팩트]** 파이프라인은 “품질·재현성·보안·비용”의 공통 기반이며, 계약서(Contract) 없이는 운영이 흔들림.
- **[의견]** P0는 **게이트(보안/근거/인용) + Retrieval 품질 + Judge Contract**를 먼저 “고정”해야 함.
- **제안**
  - P0 구현 순서(추천): **ACL Gate → Retrieval(루브릭/하이브리드/리랭커K) → Evidence Pack → Judge Contract → Citation Gate**
  - 모든 단계 공통: `run_id`, `trace_span`, `error_code`, `latency_ms`, `cost_estimate` 로깅 고정

### 2.2 시스템 아키텍트
- **[팩트]** “계약서 3종( Retrieval / Judge / Eval-Gate )”이 없으면 컴포넌트 교체(리랭커·인덱스·모델)가 어려움.
- **[의견]** 각 스텝을 **명확한 I/O 스키마 + 실패조건**으로 분리해 “교체 가능”하게 설계해야 함.
- **제안**
  - RetrievalResult / EvidencePack / JudgeResult / GateResult 스키마를 버전 관리(semver)
  - Gate 실패는 예외가 아니라 **정상 종료 경로**로 취급(UX 메시지 포함)

### 2.3 IR(검색/인덱싱) 엔지니어
- **[팩트]** 루브릭이 추상적이면 쿼리 생성도 추상적이 되고, 결국 회수율이 떨어짐.
- **[의견]** P0에서 최소한 **“루브릭별 쿼리 템플릿”**을 고정해야 인덱스 튜닝이 가능.
- **제안**
  - 문서 메타(ACL/namespace/version/doc_type) 필터는 검색 전 단계에서 강제
  - 하이브리드 가중치(BM25:Vector)는 루브릭 타입별 초기값 + telemetry로 튜닝 루프

### 2.4 Search Relevance / Ranking Scientist(랭킹·리랭킹)
- **[팩트]** Retrieval 품질은 인덱스만큼 **쿼리 품질**에 좌우됨.
- **[의견]** 다음 성능 점프는 임베딩 교체보다 **(1) 루브릭별 쿼리 생성 (2) 하이브리드/리랭킹 튜닝 (3) Hard Negative 기반 회귀 방지**에서 옴.
- **제안(핵심 5개)**
  1) 루브릭별 **쿼리 3종(정의/증거/반례)** 자동 생성 → 결과 합쳐 Top-K 구성  
  2) BM25:Vector 가중치를 루브릭 카테고리별로 다르게 + telemetry로 자동 보정  
  3) 리랭커는 **Top 15~20 후보만**, 그리고 **근거 스팬(2~5문장) 선택**까지 하게 설계  
  4) Hard Negative를 자동 수집 → 리랭커/쿼리/회귀테스트 연료로 사용  
  5) Retrieval Gate를 “근거 유무”가 아니라 **Coverage Score(충족률)**로 정교화

### 2.5 데이터/플랫폼 엔지니어
- **[팩트]** 운영에서 제일 위험한 건 “실험 데이터와 운영 데이터가 섞여 재현이 안 되는 것”.
- **[의견]** Evidence Pack과 Telemetry 스키마를 먼저 고정해두면, 이후 튜닝·회귀·대시보드가 빨라짐.
- **제안**
  - EvidencePack에 `chunk_id`, `span_offsets`, `source_uri`, `namespace`, `doc_version`, `score_components`(bm25/vector/rerank) 포함
  - run 단위로 `inputs_hash`, `rubric_version`, `retrieval_config_id` 저장 → 재현성 확보

### 2.6 Eval(평가) 엔지니어
- **[팩트]** “정답률”만 보면 품질이 좋아 보이는데, 근거·인용·일관성이 무너질 수 있음.
- **[의견]** P0 성공 기준은 **근거 기반 지표**로 잡아야 함.
- **제안**
  - P0 KPI 후보(최소 세트)
    - `evidence_insufficient_rate`(근거부족률)
    - `citation_verification_fail_rate`(인용검증 실패율)
    - `judge_schema_violation_rate`(JSON 계약 위반율)
    - `p95_latency_ms` / `avg_cost_per_run`
  - 골드셋 회귀는 Consistency Gate에 묶어서 릴리즈 체크리스트로 고정

### 2.7 QA(품질) 엔지니어
- **[팩트]** 게이트 기반 시스템은 “실패 케이스가 정상 동작”이라 테스트 케이스가 더 중요함.
- **[의견]** P0에서 테스트를 ‘정답’ 중심이 아니라 **게이트 통과/실패 시나리오** 중심으로 설계해야 함.
- **제안**
  - 최소 회귀 세트: (1) 근거부족 정상 종료 (2) 인용검증 실패 (3) ACL 차단 (4) 일관성 실패
  - 계약서 스키마 변경 시 자동으로 테스트 실패하도록 스키마 검증 테스트 추가

### 2.8 보안(ACL/컴플라이언스)
- **[팩트]** RAG에서 가장 큰 사고는 “검색 단계에서 이미 유출이 발생”하는 것.
- **[의견]** ACL/namespace 필터는 “옵션”이 아니라 **Retrieval 이전의 강제 게이트**로 구현해야 함(P0 1순위).
- **제안**
  - 권한 필터는 서버 측에서 강제(클라 신뢰 금지)
  - EvidencePack에 ACL 관련 필드를 포함하되, 사용자에게는 필요 최소 정보만 노출

### 2.9 Telemetry/Observability
- **[팩트]** 병목은 대부분 “어디서 실패/지연/비용 폭발했는지 모르는 상태”에서 커짐.
- **[의견]** P1이지만, P0부터 최소 형태의 run_id 트레이싱은 반드시 넣어야 함.
- **제안**
  - 필수 로그: `run_id`, `step`, `latency_ms`, `token_in/out`, `cost_estimate`, `gate_decision`, `topk`, `rerank_k`
  - 샘플링 전략: 정상 1~5%, 실패 100% 저장(비용 최적화)

### 2.10 SRE(운영/신뢰성)
- **[팩트]** 다중 쿼리·리랭커·다중 평가가 붙으면 비용과 P95 지연이 급증한다.
- **[의견]** P0에서 가드레일(쿼터/레이트리밋/캐시)을 “뒤에” 넣으면 늦음.
- **제안**
  - 캐시 키: `(rubric_version, query_fingerprint, namespace, retrieval_config_id)`  
  - 리랭커 K 제한 + 타임아웃 + 서킷브레이커(외부 모델 장애 대비)

### 2.11 프론트엔드
- **[팩트]** “근거 부족”은 UX가 나쁘면 바로 이탈로 이어질 수 있음.
- **[의견]** 근거 부족을 실패가 아니라 **코칭형 안내 UI**로 설계해야 한다(부족 챕터/추천 자료/다음 액션).
- **제안**
  - 결과 카드 구성: 루브릭 항목별 (판정/근거/인용/부족한 자료)
  - run_id로 “결과 공유/재현 링크” 제공(디버깅/고객지원에 유리)

### 2.12 UX 라이터
- **[팩트]** “근거 부족”은 사용자가 ‘거절당했다’고 느끼기 쉽다.
- **[의견]** 문구는 “당신이 틀렸다”가 아니라 “현재 자료로는 단정 불가 + 필요한 근거”로 가야 신뢰가 오른다.
- **제안**
  - 템플릿:  
    - “현재 제공된 자료/검색된 자료에서 **(필수 근거 타입)**을 찾지 못했습니다.”  
    - “다음 중 하나를 추가하면 더 정확히 평가할 수 있어요: (A/B/C)”  

### 2.13 PM(제품/우선순위)
- **[팩트]** P0는 “가치 전달 + 안전/재현성”을 증명해야 다음 투자가 이어짐.
- **[의견]** P0 목표는 기능 많음이 아니라 **신뢰 가능한 최소 루프**(근거→판정→인용검증→로그)다.
- **제안**
  - P0 성공 정의를 숫자로 고정(아래 7장)
  - P0 데모 시나리오 3개(정상/근거부족/인용실패)로 신뢰를 보여주기

---

## 3) 크로스체크(충돌/보완) — 최신 합의
### A. 품질 vs 비용(리랭커/복수쿼리/다중평가)
- **충돌**: 품질↑ ↔ 비용·지연↑
- **합의 보완**
  - 리랭커는 **Top 15~20만**
  - Judge 다중평가는 **옵션(문제 케이스/유료 플랜)**
  - 캐시/쿼터/레이트리밋을 P0~P1 경계에서 “동시 설계”(최소형은 P0에 포함)

### B. “근거 부족” UX
- **충돌**: 안전↑ ↔ 답답함↑
- **합의 보완**
  - 근거 부족 시 “부족한 챕터/필요한 자료/다음 액션”을 명시(코칭형 UX)

### C. 루브릭 모호성
- **충돌**: 루브릭 추상 ↔ 검색/채점/테스트 붕괴
- **합의 보완**
  - 루브릭을 관측 가능한 체크포인트로 재정의(예시/반례 포함) + 버전 관리

---

## 4) 우선순위 “투표” 결과(13명) — 고정본
| 항목 | 득표(13) | 요약 코멘트 |
|---|---:|---|
| ACL/Namespace + Retrieval 필터 게이트 | 13 | 유출 방지(검색 시점 강제) |
| Judge Contract(JSON+근거강제+근거부족) | 12 | 품질/재현성의 뼈대 |
| 루브릭+루브릭별 쿼리/항목별 Retrieval | 12 | 평가 서비스의 본질 |
| 하이브리드 + 리랭커(K 제한) | 11 | 근거 회수율 실질 개선 |
| Citation Gate(인용 검증) | 10 | “근거 기반” 신뢰 확보 |
| Telemetry(run_id + 핵심지표) | 9 | 병목/실패 지점 추적 |
| Consistency Gate + 골드셋 회귀 | 8 | 릴리즈 안정성 |
| 캐시/쿼터/레이트리밋 | 8 | 비용 폭발 방지 |
| Evidence Pack 표준화 | 7 | Judge 입력 안정화 |
| Hard Negative 자산화 | 6 | 튜닝/회귀에 강력 |
| 모드 프롬프트(코칭/교정/채점) | 5 | UX/상품성 |
| Category/Difficulty 태깅 | 3 | Phase 1.5 이후 |

---

## 5) 최종 우선순위 결론(P0/P1/P2) — 최신 합의
### ✅ P0 (바로 구현: 파이프라인 “필수 골격”)
- ACL/Namespace + Retrieval 필터 게이트
- 루브릭 시스템(버전) + 루브릭별 쿼리 생성 + 항목별 Retrieval
- 하이브리드(BM25+벡터) + 리랭커(Top 후보 제한)
- Judge Contract(JSON 고정 + 근거 인용 강제 + 근거 없으면 근거 부족)
- Citation Gate(인용 원문 검증)

### ▶️ P1 (운영 안정화/성능 고도화)
- Telemetry(run_id + 핵심지표 대시보드)
- Consistency Gate + 골드셋 회귀테스트
- 캐시/쿼터/레이트리밋
- Evidence Pack 표준화
- Hard Negative 수집/활용

### 🧩 P2 (상품성/확장)
- 모드 프롬프트(코칭/교정/채점표)
- Category/Difficulty 태깅(검증 루프 포함)

---

## 6) 다음 회의에서 “결정”해야 할 3가지(고정 의제)
1) **P0 구현 순서 확정**  
   - 추천: **게이트 → 검색(루브릭/하이브리드/리랭커) → Evidence Pack → Judge → 인용검증**
2) **계약서 3종 문서화**  
   - Retrieval Contract / Judge Contract / Eval-Gate Contract
3) **P0 성공 기준(숫자) 확정**  
   - 예시(초안):  
     - `evidence_insufficient_rate` 목표  
     - `citation_verification_fail_rate` 목표  
     - `p95_latency_ms`, `avg_cost_per_run` 상한

---

## 7) (부록) P0 성공 기준(초안 템플릿 — 숫자만 채우면 되는 형태)
- 근거부족률(evidence_insufficient_rate): **__% 이하**
- 인용검증 실패율(citation_verification_fail_rate): **__% 이하**
- Judge 스키마 위반율(judge_schema_violation_rate): **__% 이하**
- P95 응답시간(p95_latency_ms): **__ms 이하**
- 평균 실행비용(avg_cost_per_run): **__원 이하** (또는 **__tokens 이하**)

---

## 8) (부록) P0 위험요소/완화(한 줄 요약)
- 루브릭 모호 → 루브릭 체크포인트화 + 예시/반례 + 버전관리
- 비용/지연 폭발 → 리랭커 K 제한 + 캐시/쿼터 + 타임아웃
- 유출 리스크 → ACL 게이트를 검색 이전에 강제 + 서버측 필터링
- “근거 부족” 이탈 → 코칭형 UX + 필요한 자료 안내

---

### 다음 단계(요청 시 즉시 제공)
- **계약서 3종(입력/출력/실패조건/로그필드)**을 이 문서 다음 버전(v1.1)으로 바로 추가해 고정 가능합니다.
