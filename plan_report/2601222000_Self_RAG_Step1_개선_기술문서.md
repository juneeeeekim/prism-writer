# Self-RAG Step 1 ê°œì„  ê¸°ìˆ  ê°œë°œ ë¬¸ì„œ

> **ë¬¸ì„œ ID**: 2601222000  
> **ì‘ì„±ì¼**: 2026-01-22  
> **ë²„ì „**: 1.0  
> **ìƒíƒœ**: ê²€í†  ëŒ€ê¸°

---

## ğŸ“‹ ë¬¸ì„œ ê°œìš”

### ëª©ì 

`NEXT_PUBLIC_ENABLE_SELF_RAG=true` í™˜ê²½ì—ì„œ Step 1 (ê²€ìƒ‰ í•„ìš” íŒë‹¨)ì˜ ì˜¤íŒ ë¬¸ì œë¥¼ í•´ê²°í•˜ì—¬, ë¬¸ì„œ ê´€ë ¨ ì§ˆë¬¸ì— ëŒ€í•´ í•­ìƒ RAG ê²€ìƒ‰ì´ ìˆ˜í–‰ë˜ë„ë¡ ê°œì„ í•©ë‹ˆë‹¤.

### í˜„ì¬ ë¬¸ì œ

- **ì¦ìƒ**: "ê¸€ì“°ê¸° íŒ ì•Œë ¤ì¤˜" ê°™ì€ ì§ˆë¬¸ì—ì„œ LLMì´ "ê²€ìƒ‰ ë¶ˆí•„ìš”"ë¡œ ì˜¤íŒ
- **ê²°ê³¼**: ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ìˆì–´ë„ ê²€ìƒ‰ë˜ì§€ ì•Šê³  "ì°¸ê³  ìë£Œ ì—†ì´" ë‹µë³€
- **ì˜í–¥ íŒŒì¼**: `frontend/src/lib/rag/selfRAG.ts` (`checkRetrievalNecessity` í•¨ìˆ˜)

---

## ğŸ‘¨â€ğŸ”¬ ì „ë¬¸ê°€ íŒ¨ë„ ë¶„ì„

### ğŸ”µ Blue Team: ê°œì„  ì œì•ˆ

#### ì „ë¬¸ê°€ A: í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ì „ë¬¸ê°€

**ì œì•ˆ 1: ë³´ìˆ˜ì  íŒë‹¨ í”„ë¡¬í”„íŠ¸ (Conservative Prompt)**

```typescript
const IMPROVED_PROMPT = `You are a retrieval necessity classifier.

âš ï¸ CRITICAL RULE: When in doubt, ALWAYS return { "needed": true }.
Your job is to ONLY skip retrieval for OBVIOUS non-document cases.

RETRIEVAL NOT NEEDED (be very strict - only these exact patterns):
- Pure greetings: "ì•ˆë…•", "ì•ˆë…•í•˜ì„¸ìš”", "Hello", "Hi"
- Math calculations: "1+1=?", "100 / 5"
- System meta-questions: "ë„ˆëŠ” ëˆ„êµ¬ì•¼?", "What can you do?"
- Time/date queries: "ì§€ê¸ˆ ëª‡ ì‹œì•¼?"

RETRIEVAL IS NEEDED (any of these conditions):
âœ… Contains keywords: ê¸€ì“°ê¸°, ë¬¸ì„œ, ìë£Œ, íŒ, ì¡°ì–¸, ë°©ë²•, ê¸°ë²•, ì˜ˆì‹œ
âœ… Asks for guidance, feedback, or recommendations
âœ… Domain-specific terminology
âœ… Question format: "~ì— ëŒ€í•´", "~ì•Œë ¤ì¤˜", "~í•´ì¤˜"
âœ… Any ambiguity â†’ DEFAULT TO needed: true

Query: "${query}"

OUTPUT (JSON only):
{ "needed": true/false, "confidence": 0.0-1.0, "reason": "..." }`;
```

**ì˜ˆìƒ íš¨ê³¼**: ì˜¤íŒìœ¨ 80% ê°ì†Œ

---

#### ì „ë¬¸ê°€ B: RAG ì•„í‚¤í…íŠ¸

**ì œì•ˆ 2: ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ ì‚¬ì „ í™•ì¸ (Pre-check)**

```typescript
async function checkRetrievalNecessity(
  query: string,
  options: SelfRAGOptions & { hasUploadedDocs?: boolean },
): Promise<RetrievalNecessityResult> {
  // ğŸ†• ë¬¸ì„œê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ê²€ìƒ‰ (Phase 1)
  if (options.hasUploadedDocs) {
    return {
      needed: true,
      confidence: 1.0,
      reason: "Documents exist - always search",
    };
  }

  // ë¬¸ì„œ ì—†ì„ ë•Œë§Œ LLM íŒë‹¨ ì‹¤í–‰
  // ... ê¸°ì¡´ ë¡œì§
}
```

**ì˜ˆìƒ íš¨ê³¼**: ë¬¸ì„œ ì—…ë¡œë“œ ì‹œ 100% ê²€ìƒ‰ ë³´ì¥

---

#### ì „ë¬¸ê°€ C: ë¹„ìš© ìµœì í™” ì „ë¬¸ê°€

**ì œì•ˆ 3: í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²• (Keyword + LLM)**

```typescript
// 1ë‹¨ê³„: ë¹ ë¥¸ í‚¤ì›Œë“œ ì²´í¬ (LLM ë¹„ìš© ì—†ìŒ)
const ALWAYS_SEARCH_KEYWORDS = [
  "ë¬¸ì„œ",
  "ìë£Œ",
  "íŒŒì¼",
  "ì—…ë¡œë“œ",
  "ì°¸ê³ ",
  "ê¸€ì“°ê¸°",
  "ì‘ì„±",
  "ê¸°ë²•",
  "íŒ",
  "ì¡°ì–¸",
  "ë°©ë²•",
  "ì˜ˆì‹œ",
  "ìƒ˜í”Œ",
  "í…œí”Œë¦¿",
];

function quickKeywordCheck(query: string): boolean {
  const lowerQuery = query.toLowerCase();
  return ALWAYS_SEARCH_KEYWORDS.some((kw) => lowerQuery.includes(kw));
}

async function checkRetrievalNecessity(
  query: string,
): Promise<RetrievalNecessityResult> {
  // ğŸ†• í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œ ì¦‰ì‹œ ê²€ìƒ‰ ê²°ì • (LLM í˜¸ì¶œ ì—†ìŒ)
  if (quickKeywordCheck(query)) {
    return {
      needed: true,
      confidence: 0.95,
      reason: "Keyword match - skip LLM",
    };
  }

  // í‚¤ì›Œë“œ ì—†ì„ ë•Œë§Œ LLM íŒë‹¨
  // ... ê¸°ì¡´ LLM í˜¸ì¶œ ë¡œì§
}
```

**ì˜ˆìƒ íš¨ê³¼**: LLM ë¹„ìš© 40% ì ˆê° + ì˜¤íŒìœ¨ 70% ê°ì†Œ

---

### ğŸ”´ Red Team: ê²€ì¦ ë° ë¦¬ìŠ¤í¬ ë¶„ì„

#### ë¦¬ìŠ¤í¬ 1: ì œì•ˆ 1 (í”„ë¡¬í”„íŠ¸ ê°œì„ )

| í•­ëª©            | í‰ê°€                                     |
| --------------- | ---------------------------------------- |
| íš¨ê³¼            | â­â­â­â­ (ë†’ìŒ)                          |
| êµ¬í˜„ ë‚œì´ë„     | â­ (ë§¤ìš° ë‚®ìŒ)                           |
| ë¦¬ìŠ¤í¬          | í”„ë¡¬í”„íŠ¸ ê¸¸ì´ ì¦ê°€ â†’ í† í° ë¹„ìš© ë¯¸ì„¸ ì¦ê°€ |
| **ë ˆë“œíŒ€ íŒì •** | âœ… **ìŠ¹ì¸** - ì¦‰ì‹œ ì ìš© ê°€ëŠ¥             |

#### ë¦¬ìŠ¤í¬ 2: ì œì•ˆ 2 (ë¬¸ì„œ ì¡´ì¬ í™•ì¸)

| í•­ëª©            | í‰ê°€                                              |
| --------------- | ------------------------------------------------- |
| íš¨ê³¼            | â­â­â­â­â­ (ë§¤ìš° ë†’ìŒ)                            |
| êµ¬í˜„ ë‚œì´ë„     | â­â­â­ (ì¤‘ê°„)                                     |
| ë¦¬ìŠ¤í¬          | `hasUploadedDocs` ì •ë³´ë¥¼ chat APIì—ì„œ ì „ë‹¬í•´ì•¼ í•¨ |
| **ë ˆë“œíŒ€ íŒì •** | âœ… **ìŠ¹ì¸** - ì¶”ê°€ ê°œë°œ í•„ìš”í•˜ì§€ë§Œ íš¨ê³¼ì          |

#### ë¦¬ìŠ¤í¬ 3: ì œì•ˆ 3 (í•˜ì´ë¸Œë¦¬ë“œ)

| í•­ëª©            | í‰ê°€                                  |
| --------------- | ------------------------------------- |
| íš¨ê³¼            | â­â­â­â­ (ë†’ìŒ)                       |
| êµ¬í˜„ ë‚œì´ë„     | â­â­ (ë‚®ìŒ)                           |
| ë¦¬ìŠ¤í¬          | í‚¤ì›Œë“œê°€ ì—†ëŠ” ìƒˆë¡œìš´ í‘œí˜„ ëˆ„ë½ ê°€ëŠ¥   |
| **ë ˆë“œíŒ€ íŒì •** | âœ… **ìŠ¹ì¸** - ì œì•ˆ 1ê³¼ ë³‘í–‰ ì‚¬ìš© ê¶Œì¥ |

---

## ğŸ† ìµœì¢… ê¶Œì¥ ì†”ë£¨ì…˜

### Phase 1: ì¦‰ì‹œ ì ìš© (1ì¼ ì´ë‚´)

- **ì œì•ˆ 1 + ì œì•ˆ 3 ì¡°í•©** ì ìš©
- í”„ë¡¬í”„íŠ¸ ê°œì„  + í‚¤ì›Œë“œ ì‚¬ì „ ì²´í¬

### Phase 2: ì¤‘ê¸° ê°œì„  (1ì£¼ ì´ë‚´)

- **ì œì•ˆ 2** ì ìš©
- `hasUploadedDocs` ì •ë³´ ì „ë‹¬ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

### Phase 3: ì¥ê¸° ëª¨ë‹ˆí„°ë§

- ì˜¤íŒ ë¡œê·¸ ìˆ˜ì§‘ ë° ë¶„ì„
- í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ë° í”„ë¡¬í”„íŠ¸ ì§€ì† ê°œì„ 

---

## ğŸ”§ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ì¦‰ì‹œ ì ìš©

#### P1-01: í‚¤ì›Œë“œ ì‚¬ì „ ì²´í¬ í•¨ìˆ˜ ì¶”ê°€

- **íŒŒì¼**: `frontend/src/lib/rag/selfRAG.ts`
- **ìœ„ì¹˜**: `checkRetrievalNecessity` í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„

```typescript
// ì¶”ê°€í•  ì½”ë“œ
const ALWAYS_SEARCH_KEYWORDS = [
  "ë¬¸ì„œ",
  "ìë£Œ",
  "íŒŒì¼",
  "ì—…ë¡œë“œ",
  "ì°¸ê³ ",
  "ê¸€ì“°ê¸°",
  "ì‘ì„±",
  "ê¸°ë²•",
  "íŒ",
  "ì¡°ì–¸",
  "ë°©ë²•",
  "ì˜ˆì‹œ",
  "ìƒ˜í”Œ",
  "í…œí”Œë¦¿",
  "í”¼ë“œë°±",
  "ê°œì„ ",
  "ìˆ˜ì •",
  "ê²€í† ",
  "ë¶„ì„",
  "ì •ë¦¬",
  "ìš”ì•½",
];

function quickKeywordCheck(query: string): boolean {
  return ALWAYS_SEARCH_KEYWORDS.some((kw) => query.includes(kw));
}
```

#### P1-02: í‚¤ì›Œë“œ ì²´í¬ ë¡œì§ ì ìš©

- **íŒŒì¼**: `frontend/src/lib/rag/selfRAG.ts`
- **í•¨ìˆ˜**: `checkRetrievalNecessity` ìƒë‹¨ì— ì¶”ê°€

```typescript
export async function checkRetrievalNecessity(
  query: string,
  options: SelfRAGOptions = {}
): Promise<RetrievalNecessityResult> {
  // ğŸ†• P1-02: í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œ ì¦‰ì‹œ ê²€ìƒ‰ ê²°ì •
  if (quickKeywordCheck(query)) {
    logger.info('[SelfRAG]', 'Keyword match - always search', {
      query: query.substring(0, 50)
    });
    return {
      needed: true,
      confidence: 0.95,
      reason: 'Keyword match - skip LLM check'
    };
  }

  // ê¸°ì¡´ ë¡œì§ ê³„ì†...
```

#### P1-03: í”„ë¡¬í”„íŠ¸ ê°œì„ 

- **íŒŒì¼**: `frontend/src/lib/rag/selfRAG.ts`
- **ìœ„ì¹˜**: `checkRetrievalNecessity` í•¨ìˆ˜ ë‚´ í”„ë¡¬í”„íŠ¸
- **ë³€ê²½**: ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ë¥¼ ë³´ìˆ˜ì  íŒë‹¨ í”„ë¡¬í”„íŠ¸ë¡œ êµì²´

---

### Phase 2: ë¬¸ì„œ ì¡´ì¬ í™•ì¸ ì—°ë™

#### P2-01: íƒ€ì… í™•ì¥

- **íŒŒì¼**: `frontend/src/lib/rag/selfRAG.ts`

```typescript
export interface SelfRAGOptions {
  // ... ê¸°ì¡´ í•„ë“œ
  /** ğŸ†• í”„ë¡œì íŠ¸ì— ì—…ë¡œë“œëœ ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ */
  hasUploadedDocs?: boolean;
}
```

#### P2-02: ragSearchService ìˆ˜ì •

- **íŒŒì¼**: `frontend/src/lib/services/chat/ragSearchService.ts`

```typescript
export interface RAGSearchOptions {
  // ... ê¸°ì¡´ í•„ë“œ
  hasUploadedDocs?: boolean;
}
```

#### P2-03: chat/route.ts ìˆ˜ì •

- **íŒŒì¼**: `frontend/src/app/api/chat/route.ts`
- ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ë¥¼ ì¡°íšŒí•˜ì—¬ `performRAGSearch`ì— ì „ë‹¬

---

## âœ… ê²€ì¦ ê³„íš

### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

| #   | ì§ˆë¬¸                    | ê¸°ëŒ€ ê²°ê³¼                    | ê²€ì¦ ë°©ë²• |
| --- | ----------------------- | ---------------------------- | --------- |
| 1   | "ì•ˆë…•í•˜ì„¸ìš”"            | `needed: false`              | ë¡œê·¸ í™•ì¸ |
| 2   | "ê¸€ì“°ê¸° íŒ ì•Œë ¤ì¤˜"      | `needed: true` (í‚¤ì›Œë“œ ë§¤ì¹­) | ë¡œê·¸ í™•ì¸ |
| 3   | "ë¬¸ì„œì—ì„œ í•µì‹¬ ì°¾ì•„ì¤˜"  | `needed: true` (í‚¤ì›Œë“œ ë§¤ì¹­) | ë¡œê·¸ í™•ì¸ |
| 4   | "ë‚´ ê¸€ í”¼ë“œë°± í•´ì¤˜"     | `needed: true` (í‚¤ì›Œë“œ ë§¤ì¹­) | ë¡œê·¸ í™•ì¸ |
| 5   | "1+1ì€?"                | `needed: false`              | ë¡œê·¸ í™•ì¸ |
| 6   | "ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œìš”?" | `needed: true` (ë³´ìˆ˜ì  íŒë‹¨) | ë¡œê·¸ í™•ì¸ |

### ê²€ì¦ ë°©ë²•

```bash
# 1. ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸
npm run dev

# 2. ë¸Œë¼ìš°ì €ì—ì„œ ì±„íŒ… í…ŒìŠ¤íŠ¸ í›„ ì½˜ì†” ë¡œê·¸ í™•ì¸
# [SelfRAG] Keyword match - always search
# [SelfRAG] Retrieval necessity check completed { needed: true, confidence: 0.95 }

# 3. Vercel ë°°í¬ í›„ ëŸ°íƒ€ì„ ë¡œê·¸ í™•ì¸
```

---

## ğŸ“… ì¼ì •

| ë‹¨ê³„    | ì‘ì—…                        | ì˜ˆìƒ ì†Œìš” | ë‹´ë‹¹   |
| ------- | --------------------------- | --------- | ------ |
| Phase 1 | í‚¤ì›Œë“œ ì²´í¬ + í”„ë¡¬í”„íŠ¸ ê°œì„  | 2ì‹œê°„     | ê°œë°œíŒ€ |
| Phase 1 | ë¡œì»¬ í…ŒìŠ¤íŠ¸                 | 1ì‹œê°„     | ê°œë°œíŒ€ |
| Phase 1 | Vercel ë°°í¬ ë° ê²€ì¦         | 30ë¶„      | ê°œë°œíŒ€ |
| Phase 2 | ë¬¸ì„œ ì¡´ì¬ í™•ì¸ ì—°ë™         | 4ì‹œê°„     | ê°œë°œíŒ€ |
| Phase 3 | ëª¨ë‹ˆí„°ë§ ë° ê°œì„             | ì§€ì†ì     | ê°œë°œíŒ€ |

---

## ğŸ¯ ì„±ê³µ ì§€í‘œ

| ì§€í‘œ                             | í˜„ì¬      | ëª©í‘œ  |
| -------------------------------- | --------- | ----- |
| ê²€ìƒ‰ ìŠ¤í‚µ ì˜¤íŒìœ¨                 | ì¶”ì • 30%+ | < 5%  |
| ë¬¸ì„œ ê´€ë ¨ ì§ˆë¬¸ ì‹œ ê²€ìƒ‰ìœ¨         | ë¶ˆí™•ì‹¤    | 100%  |
| ë¶ˆí•„ìš”í•œ ê²€ìƒ‰ ìŠ¤í‚µìœ¨ (ì¸ì‚¬ë§ ë“±) | N/A       | > 90% |

---

## ğŸ“ ì°¸ê³  ìë£Œ

- [Self-RAG ë…¼ë¬¸](https://arxiv.org/abs/2310.11511)
- `frontend/src/lib/rag/selfRAG.ts` - í˜„ì¬ êµ¬í˜„
- `frontend/src/lib/services/chat/ragSearchService.ts` - RAG ê²€ìƒ‰ ì„œë¹„ìŠ¤
- `frontend/src/config/featureFlags.ts` - Feature Flag ì„¤ì •

---

## âœï¸ ìŠ¹ì¸

| ì—­í•         | ì´ë¦„ | ì„œëª… | ë‚ ì§œ |
| ----------- | ---- | ---- | ---- |
| ê¸°ìˆ  ë¦¬ë”   |      |      |      |
| RAG ì „ë¬¸ê°€  |      |      |      |
| ë ˆë“œíŒ€ ë¦¬ë” |      |      |      |
