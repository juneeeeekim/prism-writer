# 피드백 동기화 기능 구현 계획서

**작성일**: 2026-01-17  
**목표**: 프로젝트 내 LLM 피드백이 모든 기기/세션에서 동일하게 유지되도록 개선

---

## 1. 현재 문제점

| 항목            | 현재 상태                                   |
| --------------- | ------------------------------------------- |
| **피드백 저장** | ✅ `learning_events` 테이블에 정상 저장     |
| **피드백 조회** | ❌ 메시지 로드 시 피드백 상태 불러오지 않음 |
| **결과**        | 다른 PC에서 접속하면 피드백 버튼이 초기화됨 |

---

## 2. 해결 방안 개요

```
[현재]
메시지 로드 → chat_messages만 조회 → 피드백 상태 없음

[개선]
메시지 로드 → chat_messages + learning_events 조인 → 피드백 상태 포함
```

---

## 3. 구현 체크리스트

### Phase 1: 백엔드 API 수정

- [ ] **P1-01**: `/api/chat/sessions/[id]/route.ts` 수정
  - `learning_events` 테이블에서 `message_id` 기준으로 피드백 조회
  - 메시지 응답에 `feedback` 필드 추가

### Phase 2: 프론트엔드 수정

- [ ] **P2-01**: `ChatTab.tsx` - `Message` 인터페이스에 `feedback` 필드 추가
- [ ] **P2-02**: `ChatTab.tsx` - 메시지 로드 시 `feedback` 필드 매핑
- [ ] **P2-03**: `AdaptiveFeedbackButtons.tsx` - `initialFeedback` prop 추가 및 적용

### Phase 3: 검증

- [ ] **P3-01**: A PC에서 피드백 → B PC에서 동일 상태 확인
- [ ] **P3-02**: 새로고침 후에도 피드백 상태 유지 확인

---

## 4. 상세 구현 내용

### P1-01: 백엔드 API 수정

**파일**: `frontend/src/app/api/chat/sessions/[id]/route.ts`

```typescript
// 메시지 조회 후, 각 메시지에 대한 피드백 상태 조회
const { data: feedbacks } = await supabase
  .from("learning_events")
  .select("event_data, event_type")
  .eq("user_id", user.id)
  .eq("project_id", session.project_id)
  .in("event_type", ["chat_helpful", "chat_not_helpful", "chat_hallucination"]);

// 메시지에 피드백 매핑
const messagesWithFeedback = messages.map((msg) => ({
  ...msg,
  feedback:
    feedbacks?.find((f) => f.event_data?.messageId === msg.id)?.event_type ||
    null,
}));
```

### P2-03: 프론트엔드 컴포넌트 수정

**파일**: `frontend/src/components/chat/AdaptiveFeedbackButtons.tsx`

```typescript
interface AdaptiveFeedbackButtonsProps {
  messageId: string;
  projectId: string;
  initialFeedback?: SignalType | null; // 새로 추가
}

// 컴포넌트 내부
const [submitted, setSubmitted] = useState<SignalType | null>(
  initialFeedback ?? null,
);
```

---

## 5. 예상 작업 시간

| Phase    | 예상 시간         |
| -------- | ----------------- |
| Phase 1  | 30분              |
| Phase 2  | 30분              |
| Phase 3  | 15분              |
| **합계** | **약 1시간 15분** |

---

## 6. 승인 요청

위 계획대로 진행해도 될까요?
