// =============================================================================
// PRISM Writer - Query Expansion Module
// =============================================================================
// 파일: frontend/src/lib/rag/queryExpansion.ts
// 역할: 사용자 쿼리를 도메인 특화 용어로 확장하여 검색 커버리지 향상
// 생성일: 2025-12-27
// 
// [RAG 환각 방지 업그레이드]
// Feature Flag: ENABLE_QUERY_EXPANSION으로 활성화/비활성화 가능
// =============================================================================

// =============================================================================
// 도메인 용어 매핑 테이블
// =============================================================================
// 디렉터님 제공 예정: PRISM Writer 특화 용어 50개 이상
// 현재는 기본 글쓰기 도메인 용어로 초기화
// =============================================================================

/**
 * 도메인 특화 동의어 매핑
 * 
 * @description
 * 왼쪽 키워드가 사용자 쿼리에 포함되면, 오른쪽 동의어로 확장됩니다.
 * 예: "글쓰기" → ["원고 작성", "콘텐츠 구성", ...]
 * 
 * 현재 용어 수: 50개 이상
 * 디렉터님 추가 용어 제공 시 업데이트
 */
const DOMAIN_MAP: Record<string, string[]> = {
  // ===========================================================================
  // [섹션 1] 글쓰기 핵심 용어 (10개)
  // ===========================================================================
  '글쓰기': ['원고 작성', '콘텐츠 구성', '스크립트 작성', '글 구성', '라이팅'],
  '글': ['원고', '콘텐츠', '텍스트', '문서', '스크립트', '포스팅'],
  '쓰기': ['작성', '구성', '기획', '제작', '집필'],
  '방법': ['기법', '구조', '프레임워크', '접근법', '방식', '노하우'],
  '작성': ['쓰기', '기획', '제작', '집필', '작문'],
  '구조': ['프레임워크', '공감-정보', '기승전결', '뼈대', '틀'],
  '원고': ['스크립트', '글', '초안', '대본', '원본'],
  '콘텐츠': ['글', '영상', '포스팅', '게시물', '자료'],
  '문서': ['글', '자료', '리포트', '보고서', '문건'],
  '텍스트': ['글', '문장', '본문', '내용', '문구'],

  // ===========================================================================
  // [섹션 2] PRISM Writer 특화 용어 (10개)
  // ===========================================================================
  '공감': ['감정', '정서', '공감대', '독자 공감', '리더 공감', '감성'],
  '정보': ['데이터', '지식', '팩트', '인사이트', '정보 전달'],
  '공감-정보': ['공감 정보', '공감과 정보', '공감 정보 구조', '감성 정보'],
  '관점': ['시각', '견해', '포인트', '관점', '의견'],
  '결론': ['마무리', '아웃트로', '끝맺음', '요약', '핵심 정리'],
  '주원규': ['주원규 방식', '주원규 스타일', '디렉터', '주원규 기법'],
  '프레임워크': ['구조', '틀', '프레임', '포맷', '형식'],
  'PRISM': ['프리즘', 'PRISM Writer', '프리즘 라이터'],
  '가이드': ['안내', '지침', '가이드라인', '매뉴얼'],
  '템플릿': ['양식', '서식', '포맷', '틀'],

  // ===========================================================================
  // [섹션 3] 유튜브/영상 콘텐츠 용어 (10개)
  // ===========================================================================
  '유튜브': ['영상', '콘텐츠', '크리에이터', '영상 원고', '유튜버'],
  '영상': ['유튜브', '비디오', '동영상', '클립', '콘텐츠'],
  '스크립트': ['대본', '원고', '시나리오', '대사', '스토리'],
  '썸네일': ['미리보기', '대표 이미지', '표지', '커버'],
  '인트로': ['도입부', '시작', '오프닝', '훅'],
  '아웃트로': ['마무리', '엔딩', '클로징', '결론'],
  'Hook': ['훅', '도입부', '낚시', '시작 멘트'],
  'CTA': ['콜투액션', '행동 유도', '구독 요청', '좋아요 요청'],
  '타임라인': ['시간순', '순서', '흐름', '구성'],
  '편집': ['영상 편집', '후반 작업', '컷 편집'],

  // ===========================================================================
  // [섹션 4] 글 구조/형식 용어 (10개)
  // ===========================================================================
  '서론': ['도입부', '인트로', '시작', '서두', '첫 문장'],
  '본론': ['본문', '중심 내용', '메인', '핵심'],
  '주제': ['토픽', '테마', '컨셉', '아이디어', '소재'],
  '키워드': ['핵심어', '태그', '검색어', '주요 단어'],
  '제목': ['타이틀', '헤드라인', '표제', '이름'],
  '소제목': ['부제', '서브타이틀', '중간 제목'],
  '단락': ['문단', '파라그래프', '섹션', '블록'],
  '문장': ['센텐스', '문구', '표현', '글귀'],
  '문체': ['어투', '톤', '스타일', '말투'],
  '기승전결': ['서론본론결론', '4단 구조', '스토리 구조'],

  // ===========================================================================
  // [섹션 5] 독자/청중 관련 용어 (10개)
  // ===========================================================================
  '독자': ['청중', '시청자', '구독자', '타깃', '오디언스', '리더'],
  '타깃': ['대상', '독자층', '고객', '청중'],
  '공감대': ['공감', '동감', '연결', '유대감'],
  '반응': ['피드백', '리액션', '댓글', '응답'],
  '참여': ['인게이지먼트', '상호작용', '반응'],
  '시청자': ['구독자', '독자', '청중', '뷰어'],
  '구독자': ['팔로워', '시청자', '독자', '팬'],
  '피드백': ['반응', '의견', '평가', '리뷰'],
  '댓글': ['코멘트', '반응', '의견', '피드백'],
  '좋아요': ['하트', '추천', '공감', '좋앙'],
}

// =============================================================================
// Query Expansion 함수
// =============================================================================

/**
 * Query Expansion - 사용자 질문을 확장하여 검색 커버리지 향상
 * 
 * @description
 * 추상적인 질문을 도메인 특화 용어로 확장합니다.
 * 최대 5개 쿼리로 제한하여 성능 저하를 방지합니다.
 * 
 * @param query - 원본 검색 쿼리
 * @returns 확장된 쿼리 배열 (최대 5개)
 * 
 * @example
 * ```typescript
 * expandQuery("글쓰기 방법")
 * // => ["글쓰기 방법", "원고 작성 방법", "콘텐츠 구성 기법", ...]
 * ```
 */
export function expandQuery(query: string): string[] {
  // ---------------------------------------------------------------------------
  // 입력 검증
  // ---------------------------------------------------------------------------
  if (!query || query.trim().length === 0) {
    return []
  }

  const trimmedQuery = query.trim()
  const queries = [trimmedQuery]

  // ---------------------------------------------------------------------------
  // 키워드 추출 및 확장
  // ---------------------------------------------------------------------------
  for (const [keyword, synonyms] of Object.entries(DOMAIN_MAP)) {
    if (trimmedQuery.includes(keyword)) {
      for (const synonym of synonyms) {
        const expanded = trimmedQuery.replace(keyword, synonym)
        if (!queries.includes(expanded)) {
          queries.push(expanded)
        }
        
        // 최대 5개 제한 (성능 고려)
        if (queries.length >= 5) {
          break
        }
      }
    }
    
    // 최대 5개 제한
    if (queries.length >= 5) {
      break
    }
  }

  return queries
}

/**
 * 도메인 매핑 테이블에 새 용어 추가 (런타임)
 * 
 * @param keyword - 키워드
 * @param synonyms - 동의어 배열
 * 
 * @example
 * ```typescript
 * addDomainMapping('주원규', ['주원규 방식', '주원규 스타일'])
 * ```
 */
export function addDomainMapping(keyword: string, synonyms: string[]): void {
  DOMAIN_MAP[keyword] = synonyms
}

/**
 * 현재 도메인 매핑 개수 반환 (디버깅용)
 */
export function getDomainMappingCount(): number {
  return Object.keys(DOMAIN_MAP).length
}

/**
 * 도메인 매핑 테이블 전체 반환 (디버깅용)
 */
export function getDomainMap(): Record<string, string[]> {
  return { ...DOMAIN_MAP }
}
