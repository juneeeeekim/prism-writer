-- =============================================================================
-- PRISM Writer - 프로필 RLS 진단 쿼리
-- =============================================================================
-- 파일: 016_diagnose_profile_rls.sql
-- 용도: 프로필 데이터가 프론트엔드에서 표시되지 않는 문제 진단
-- 실행: Supabase SQL Editor에서 실행 (마이그레이션 아님)
-- =============================================================================

-- =============================================================================
-- 1. RLS 정책 확인
-- =============================================================================
-- 현재 profiles 테이블에 설정된 RLS 정책 목록
SELECT 
    policyname AS "정책명", 
    cmd AS "명령", 
    qual AS "조건"
FROM pg_policies 
WHERE tablename = 'profiles';

-- =============================================================================
-- 2. 직접 데이터 조회 (RLS 우회)
-- =============================================================================
-- SQL Editor는 service_role로 실행되므로 RLS 우회
SELECT 
    id, 
    role, 
    tier, 
    is_approved, 
    daily_request_limit, 
    monthly_token_limit
FROM profiles
WHERE id = (
    SELECT id FROM auth.users 
    WHERE email = 'juneeee.kim@gmail.com'
);

-- =============================================================================
-- 3. RLS 정책이 제대로 작동하는지 테스트
-- =============================================================================
-- 아래 쿼리가 결과를 반환하면 RLS 정책이 정상
-- (SQL Editor에서는 service_role이므로 항상 결과가 나옴)

-- public 접근 테스트 (anon key로 테스트해야 정확함)
-- 프론트엔드에서 문제가 생기면:
-- 1) RLS 정책 조건이 잘못됨
-- 2) auth.uid()가 제대로 설정되지 않음

-- =============================================================================
-- 해결책: RLS 정책에 문제가 있으면 아래 실행
-- =============================================================================
/*
-- 기존 정책 삭제
DROP POLICY IF EXISTS "Users can view own profile" ON profiles;

-- 새 정책 생성 (더 간단한 조건)
CREATE POLICY "Users can view own profile"
    ON profiles FOR SELECT
    USING (auth.uid() = id OR EXISTS (
        SELECT 1 FROM auth.users WHERE id = auth.uid()
    ));
*/
