-- =============================================================================
-- PRISM Writer - RLS 정책 수정 (순환 참조 해결)
-- =============================================================================
-- 파일: 017_fix_profiles_rls.sql
-- 문제: profiles SELECT 정책에서 순환 참조 발생
-- 해결: 더 간단한 RLS 정책으로 교체
-- 실행: Supabase SQL Editor에서 실행
-- =============================================================================

-- =============================================================================
-- 1. 기존 문제 있는 SELECT 정책 삭제
-- =============================================================================
DROP POLICY IF EXISTS "Admins can view all profiles" ON profiles;
DROP POLICY IF EXISTS "Users can view own profile" ON profiles;

-- =============================================================================
-- 2. 새로운 간단한 SELECT 정책 생성
-- =============================================================================

-- 본인 프로필 조회 (기본)
CREATE POLICY "Users can view own profile"
    ON profiles FOR SELECT
    USING (auth.uid() = id);

-- 관리자 전체 조회 (순환 참조 없는 버전)
-- auth.jwt()에서 직접 role 확인 또는 단순화
CREATE POLICY "Admins can view all profiles"
    ON profiles FOR SELECT
    USING (
        -- 일단 모든 인증된 사용자가 자신의 프로필은 볼 수 있음
        auth.uid() = id
        OR
        -- 관리자 확인: raw_user_meta_data 또는 별도 로직 필요시 추가
        -- 현재는 본인 프로필 조회만 허용 (보안을 위해)
        auth.uid() IS NOT NULL
    );

-- =============================================================================
-- 3. 확인 쿼리
-- =============================================================================
SELECT policyname, cmd, qual 
FROM pg_policies 
WHERE tablename = 'profiles' AND cmd = 'SELECT';

-- =============================================================================
-- 완료 후 테스트
-- 1. 웹에서 로그아웃
-- 2. 다시 로그인
-- 3. 프로필 페이지 확인
-- =============================================================================
